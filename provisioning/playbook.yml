---
- name: Install Consul
  hosts: consul
  become: yes
  tasks:
    - name: Install unzip
      apt:
        name: unzip
        state: present
        update_cache: yes

    - name: Download Consul binary
      unarchive:
        src: "{{consul_url}}/{{consul_version}}/consul_{{consul_version}}_linux_amd64.zip"
        dest: /usr/local/bin
        remote_src: yes
        creates: /usr/local/bin/consul

    - name: Setup bash autocompletion
      lineinfile: 
        path: /home/vagrant/.bashrc
        line: complete -C /usr/local/bin/consul consul
        state: present

    - name: Add Consul system user
      user:
        name: consul
        system: yes
        home: /etc/consul.d
        shell: /bin/false
        state: present

    - name: Create Consul data directory
      file:
        path: /opt/consul
        owner: consul
        group: consul
        recurse: yes
        state: directory
    
    - name: Create Consul configuration directory
      file:
        path: /etc/consul.d
        state: directory
        owner: consul
        group: consul
        recurse: yes

    - name: Create Consul configuration file
      template:
        src: consul.hcl.j2
        dest: /etc/consul.d/consul.hcl
        mode: 0640
        owner: consul
        group: consul

- name: Setup Consul server
  hosts: consul-server
  become: yes
  tasks:
    - name: Create Consul server configuration file
      template:
        src: consul_server.hcl.j2
        dest: /etc/consul.d/server.hcl
        mode: 0640
        owner: consul
        group: consul

- name: Install Nomad
  hosts: nomad
  become: yes
  tasks:
    - name: Install unzip
      apt:
        name: [ unzip ]
        state: present
        update_cache: yes

    - name: Get Docker installer script
      get_url:
        url: https://get.docker.com
        dest: ./get-docker.sh
        mode: u+x

    - name: Install Docker
      shell: 
        cmd: ./get-docker.sh
        executable: /bin/sh
        creates: /usr/bin/docker

    - name: Add Vagrant user to docker group
      user:
        name: vagrant
        append: yes
        groups: docker

    - name: Download Nomad binary
      unarchive:
        src: "{{nomad_url}}/{{nomad_version}}/nomad_{{nomad_version}}_linux_amd64.zip"
        dest: /usr/local/bin
        remote_src: yes
        creates: /usr/local/bin/nomad

    - name: Setup bash autocompletion
      lineinfile: 
        path: /home/vagrant/.bashrc
        line: complete -C /usr/local/bin/nomad nomad
        state: present

    - name: Create Nomad data directory
      file:
        path: /opt/nomad
        state: directory
    
    - name: Create Nomad configuration directory
      file:
        path: /etc/nomad.d
        state: directory

    - name: Create Nomad configuration file
      template:
        src: nomad.hcl.j2
        dest: /etc/nomad.d/nomad.hcl
        mode: 0640

- name: Setup Nomad server
  hosts: nomad-server
  become: yes
  tasks:
    - name: Create Nomad server configuration file
      template:
        src: nomad_server.hcl.j2
        dest: /etc/nomad.d/server.hcl
        mode: 0640

- name: Setup Nomad nodes
  hosts: nomad_clients
  become: yes
  tasks:
    - name: Create client config file
      template:
        src: nomad_client.hcl.j2
        dest: /etc/nomad.d/client.hcl
        mode: 0640

- name: Consul service
  hosts: consul
  become: yes
  tasks:
    - name: Create Consul service
      copy:
        src: consul.service
        dest: /etc/systemd/system/consul.service

    - name: Enable and start Consul service
      service:
        name: consul
        state: started
        enabled: yes

- name: Nomad service
  hosts: nomad
  become: yes
  tasks: 
    - name: Create Nomad service
      copy:
        src: nomad.service
        dest: /etc/systemd/system/nomad.service

    - name: Enable and start Nomad service
      service:
        name: nomad
        state: started
        enabled: yes

- name: Setup /etc/hosts
  hosts: all
  become: yes
  tasks:
    - name: Add hosts in /etc/hosts
      blockinfile:
        path: /etc/hosts
        block: "{{etc_hosts}}"
        state: present